<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with DeepSeek</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh; /* Full height for the page */
        display: flex; /* Flex layout for sidebar and content */
        background-color: #f0f2f5;
      }

      /* Sidebar styles */
      .sidebar {
        width: 250px; /* Sidebar width */
        background-color: #333; /* Sidebar background color */
        color: white;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        flex-shrink: 0; /* Prevent the sidebar from shrinking */
      }

      .sidebar h2 {
        margin-top: 0;
        font-size: 1.5em;
      }

      .sidebar ul {
        list-style: none;
        padding: 0;
      }

      .sidebar ul li {
        margin: 15px 0;
      }

      .sidebar ul li a {
        color: white;
        text-decoration: none;
        font-size: 1rem;
        transition: color 0.3s;
      }

      .sidebar ul li a:hover {
        color: #2196f3; /* Link hover color */
      }

      /* Main chat container styles */
      .main-content {
        flex-grow: 1; /* Take up the remaining space in the layout */
        display: flex;
        flex-direction: column;
        padding: 20px;
      }

      .chat-container {
        flex: 1; /* Make the chat container take up all available vertical space */
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .chat-box {
        flex-grow: 1; /* Ensures the chat container expands to take remaining vertical space */
        overflow-y: auto; /* Adds vertical scrolling when content overflows */
        overflow-x: hidden; /* Ensures horizontal scrolling is disabled */
        background-color: white;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Updated styling for user and assistant interactions */
      .line {
        display: flex;
        justify-content: flex-start; /* Default alignment to the left */
        margin-bottom: 15px;
        word-wrap: break-word;
      }

      .line.user {
        justify-content: flex-end; /* Align user messages to the right */
      }

      .line.assistant {
        justify-content: flex-start; /* Align assistant messages to the left */
      }

      .message {
        max-width: 70%; /* Limit message width for better readability */
        padding: 12px 16px;
        border-radius: 15px;
        margin: 5px 0;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.4;
      }

      .user-message {
        background-color: #2196f3;
        color: white;
        border-radius: 15px 15px 0 15px; /* Rounded corners */
        text-align: left;
      }

      .assistant-message {
        background-color: #f1f8e9;
        color: #2e7d32;
        border-radius: 15px 15px 15px 0; /* Rounded corners */
        text-align: left;
      }

      /* Add extra spacing between messages and container edges */
      .chat-box {
        padding: 20px;
        overflow-y: auto;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Make scrollbar visually distinct */
      .chat-box::-webkit-scrollbar {
        width: 8px;
      }

      .chat-box::-webkit-scrollbar-thumb {
        background-color: #cccccc;
        border-radius: 4px;
      }

      .chat-box::-webkit-scrollbar-thumb:hover {
        background-color: #888888;
      }

      .timestamp {
        font-size: 0.75rem;
        color: #666;
        margin-top: 5px;
      }

      form {
        margin-top: 10px;
        display: flex;
        gap: 10px;
      }

      input[type="text"] {
        flex-grow: 1;
        padding: 8px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 20px;
        font-size: 14px;
      }

      button {
        padding: 8px 16px;
        background-color: #2196f3;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #1976d2;
      }

      .reset-button {
        margin-top: 10px;
        padding: 8px 16px;
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .reset-button:hover {
        background-color: #d32f2f;
      }
      /* Active session styling */
      .session-item.active a {
        color: #2196f3; /* Highlighted color */
        font-weight: bold;
      }
      .session-item.active {
        background-color: rgba(
          33,
          150,
          243,
          0.15
        ); /* Light blue background for active session */
        border-radius: 5px;
      }
    </style>
    <!-- Load the marked.js library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="sidebar" id="sidebar">
      <h2>Menu</h2>
      <ul id="session-list"></ul>
      <button id="new-session-btn">+ New Chat</button>
    </div>

    <div class="main-content">
      <div class="chat-container">
        <div class="chat-box" id="chat-box">
          <div class="line bot">Welcome! Ask me anything.</div>
        </div>

        <form id="chat-form">
          <input
            type="text"
            id="user-input"
            placeholder="Write a message..."
            autocomplete="off"
          />
          <button type="submit">Send</button>
        </form>
      </div>
    </div>

    <script>
      // Fetch and display session list
      let currentSessionId = null; // Store the ID of the current session

      // Fetch and display sessions
      async function loadSessions() {
        const response = await fetch("/sessions");
        const sessions = await response.json();
        const sessionList = document.getElementById("session-list");
        sessionList.innerHTML = "";

        sessions.forEach((session) => {
          const li = document.createElement("li");

          // Highlight the active session
          li.classList.add("session-item");
          if (session.session_id === currentSessionId) {
            li.classList.add("active"); // Style the active session differently
          }

          li.innerHTML = `
            <a href="#" onclick="loadChat(${session.session_id})">${session.session_name}</a>
            <button onclick="deleteSession(${session.session_id})">‚ùå</button>
        `;

          sessionList.appendChild(li);
        });
      }

      // Create a new session
      document.getElementById("new-session-btn").onclick = async () => {
        const sessionName = prompt("Enter session name:") || "Untitled Session";
        const response = await fetch("/new_session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_name: sessionName }),
        });

        const newSession = await response.json();
        currentSessionId = newSession.session_id; // Set the newly created session as active
        loadSessions();
        loadChat(currentSessionId); // Automatically load the new session
      };

      // Delete a session
      async function deleteSession(sessionId) {
        if (currentSessionId === sessionId) {
          alert("You cannot delete the active session!");
          return;
        }

        await fetch(`/delete_session/${sessionId}`, { method: "DELETE" });
        loadSessions();
      }

      // Load chat session
      // Load chat session
      async function loadChat(sessionId) {
        currentSessionId = sessionId; // Track the active session

        try {
          // Fetch chat history from the backend
          const response = await fetch(`/sessions/${sessionId}`);
          const sessionData = await response.json();

          if (response.status === 404) {
            alert("Session not found.");
            return;
          }

          const chatBox = document.getElementById("chat-box");
          chatBox.innerHTML = ""; // Clear old messages

          // Loop through each message and dynamically create DOM elements
          sessionData.messages.forEach((message) => {
            // Create a container for the message (line)
            const messageContainer = document.createElement("div");
            messageContainer.classList.add("line", message.role);

            // Create a div for the message content
            const messageContent = document.createElement("div");
            messageContent.classList.add("message", `${message.role}-message`);
            messageContent.innerHTML = marked.parse(message.content); // Parse the message content as Markdown
            messageContainer.appendChild(messageContent);

            // Append the entire line (message) to the chat-box
            chatBox.appendChild(messageContainer);
          });

          // Highlight the newly active session in the sidebar
          highlightActiveSession(sessionId);

          // Scroll to the bottom to show the most recent message
          chatBox.scrollTop = chatBox.scrollHeight;
        } catch (err) {
          console.error("Error loading chat session:", err);
          alert("Failed to load chat session.");
        }
      }

      // Highlight the active session in the sidebar
      function highlightActiveSession(sessionId) {
        const sessionListItems = document.querySelectorAll(
          "#session-list .session-item"
        );
        sessionListItems.forEach((item) => {
          item.classList.remove("active"); // Remove active class from all items
          if (item.querySelector(`a[onclick="loadChat(${sessionId})"]`)) {
            item.classList.add("active");
          }
        });
      }

      // Submit a new message
      const chatBox = document.getElementById("chat-box");
      const chatForm = document.getElementById("chat-form");
      const userInput = document.getElementById("user-input");

      chatForm.onsubmit = async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message || !currentSessionId) {
          alert("Please select or create a session first.");
          return;
        }

        // Append the user's message to the chatbox
        chatBox.innerHTML += `<div class="line user"><div class="message user-message">${message}</div></div>`;
        userInput.value = "";

        try {
          // Send the user's message to the backend
          const response = await fetch("/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id: currentSessionId, message }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Server error: ${errorText}`);
          }

          // Stream the assistant's response incrementally
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let botMessage = "";

          // Create a div for the assistant's message
          const botMessageContainer = document.createElement("div");
          botMessageContainer.classList.add("line", "assistant");
          const botMessageContent = document.createElement("div");
          botMessageContent.classList.add("message", "assistant-message");
          botMessageContainer.appendChild(botMessageContent);
          chatBox.appendChild(botMessageContainer);

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            // Decode the streamed chunk and append it
            const chunk = decoder.decode(value, { stream: true });
            botMessage += chunk;
            botMessageContent.innerHTML = marked.parse(botMessage); // Support Markdown formatting

            // Scroll to the latest message
            chatBox.scrollTop = chatBox.scrollHeight;
          }
        } catch (err) {
          chatBox.innerHTML += `<div class="line bot"><div class="message bot-message">Error: Could not connect to server or stream response.</div></div>`;
        }

        // Ensure the view scrolls to the bottom
        chatBox.scrollTop = chatBox.scrollHeight;
      };

      // Load sessions on page load
      window.onload = loadSessions;
    </script>
  </body>
</html>
